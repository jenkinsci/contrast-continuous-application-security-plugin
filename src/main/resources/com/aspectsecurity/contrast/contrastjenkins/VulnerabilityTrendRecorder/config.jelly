<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:f="/lib/form" xmlns:st="jelly:stapler">

    <f:section title="Vulnerability Threshold Conditions">
        <f:entry title="TeamServer Profile" field="teamServerProfileName">
            <f:select/>
        </f:entry>

        <f:entry title="Query vulnerabilities by" field="queryBy" >
            <f:entry>
                <f:radio name="queryBy" title="appVersionTag, format: applicationId-buildNumber" value="1" checked="true" />
            </f:entry>
            <f:entry>
                <f:radio name="queryBy" title="appVersionTag, format: applicationId-buildName-buildNumber" value="2" checked="${instance.queryBy == 2}" />
            </f:entry>
            <f:entry>
                <f:radio name="queryBy" title="appVersionTag, format: applicationId-buildFullName-buildNumber" value="4" checked="${instance.queryBy == 4}" />
            </f:entry>
            <f:entry help="/plugin/contrast-continuous-application-security/help-queryBy.html">
                <f:radio name="queryBy" title="startDate (Build timestamp)" value="3" checked="${instance.queryBy == 3}" />
            </f:entry>
        </f:entry>

        <f:entry>
            <f:checkbox title="Override Global Threshold Conditions" name="overrideGlobalThresholdConditions" field="overrideGlobalThresholdConditions"/>
        </f:entry>


        <f:entry description="Conditions for verifying your build">
            <f:repeatable field="conditions">
                <table width="100%">
                    <f:entry title="Application Id" help="/plugin/contrast-continuous-application-security/help-applicationId.html" field="applicationId">
                        <f:select/>
                    </f:entry>

                    <f:entry title="Count" field="thresholdCount"
                             help="/plugin/contrast-continuous-application-security/help-thresholdCount.html">
                        <f:number name="thresholdCount" field="thresholdCount" default="0"
                                  clazz="required positive-number"/>
                    </f:entry>

                    <f:entry title="Severity" field="thresholdSeverity"
                             help="/plugin/contrast-continuous-application-security/help-thresholdSeverity.html">
                        <f:select/>
                    </f:entry>

                    <f:entry title="Vulnerability Type" field="thresholdVulnType"
                             help="/plugin/contrast-continuous-application-security/help-thresholdVulnType.html">
                        <f:select/>
                    </f:entry>

                    <f:entry title="Vulnerability statuses" help="/plugin/contrast-continuous-application-security/help-vulnerabilityStatus.html">
                        <f:checkbox title="Auto-Remediated" name="autoRemediated" field="autoRemediated"/>
                    </f:entry>

                    <f:entry>
                        <f:checkbox title="Not a Problem" name="notAProblem" field="notAProblem"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Fixed" name="fixed" field="fixed"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Confirmed" name="confirmed" field="confirmed"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Remediated" name="remediated" field="remediated"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Being Tracked" name="beingTracked" field="beingTracked"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Suspicious" name="suspicious" field="suspicious"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Reported" name="reported" field="reported"/>
                    </f:entry>
                    <f:entry>
                        <f:checkbox title="Untracked" name="untracked" field="untracked"/>
                    </f:entry>

                    <f:entry title="">
                        <div align="right">
                            <f:repeatableDeleteButton/>
                        </div>
                    </f:entry>
                </table>
            </f:repeatable>
        </f:entry>
    </f:section>
    <script>
        var overrideGlobalThresholdConditionsCheckboxElements =
        document.getElementsByName("overrideGlobalThresholdConditions");
        var teamServerProfileSelectElements = document.getElementsByName("_.teamServerProfileName");

        <!-- All the fields of a Threshold Condition except the application id will be hidden if the global threshold conditions are used -->
        var thresholdCountElements = document.getElementsByName("thresholdCount");
        var thresholdSeverityElements = document.getElementsByName("_.thresholdSeverity");
        var thresholdVulnTypeElements = document.getElementsByName("_.thresholdVulnType");
        var autoRemediatedElements = document.getElementsByName("autoRemediated");
        var notAProblemElements = document.getElementsByName("notAProblem");
        var fixedElements = document.getElementsByName("fixed");
        var confirmedElements = document.getElementsByName("confirmed");
        var remediatedElements = document.getElementsByName("remediated");
        var beingTrackedElements = document.getElementsByName("beingTracked");
        var suspiciousElements = document.getElementsByName("suspicious");
        var reportedElements = document.getElementsByName("reported");
        var untrackedElements = document.getElementsByName("untracked");

        var dynamicElements = [];
        dynamicElements.push(thresholdCountElements);
        dynamicElements.push(thresholdSeverityElements);
        dynamicElements.push(thresholdVulnTypeElements);
        dynamicElements.push(autoRemediatedElements);
        dynamicElements.push(notAProblemElements);
        dynamicElements.push(fixedElements);
        dynamicElements.push(confirmedElements);
        dynamicElements.push(remediatedElements);
        dynamicElements.push(beingTrackedElements);
        dynamicElements.push(suspiciousElements);
        dynamicElements.push(reportedElements);
        dynamicElements.push(untrackedElements);

        <!-- When Threshold Conditions are added to the page, observer hides all of their fields except the app name if needed -->
        var observer = new MutationObserver(function(mutations) {

            if (teamServerProfileSelectElements[0] != undefined &amp;&amp; teamServerProfileSelectElements[0].onchange == null){
                <!-- Hide fields if a teamserver profile selected with isAllowGlobalThresholdConditionsOverride variable set to false  -->
                teamServerProfileSelectElements[0].onchange = function() {isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value);};
            }
            if (overrideGlobalThresholdConditionsCheckboxElements[0] != undefined &amp;&amp; overrideGlobalThresholdConditionsCheckboxElements[0].onchange == null) {
                <!-- Hide fields if the user chooses to use global conditions  -->
                overrideGlobalThresholdConditionsCheckboxElements[0].onchange = function() { isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value); };
            }

            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0 &amp;&amp; mutation.target.className == "repeated-container") {
                    isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value);
                }
            });
        });

        observer.observe(document.querySelector("form[name=config]"), { childList: true, subtree: true });
        <!---->

        <!-- Create a proxy variable to access the descriptor of VulnerabilityTrendRecorder.java class -->
        var descriptorImpl =
        <st:bind value="${descriptor}"/>

        <!-- Checks if 'isAllowGlobalThresholdConditionsOverride' variable is set to true in the selected TeamServer profile -->
        function isAllowGlobalThresholdConditionsOverride(teamServerProfileName) {
            descriptorImpl.isAllowGlobalThresholdConditionsOverride(teamServerProfileName, function(t){
                if (t.responseObject()) {
                    overrideGlobalThresholdConditionsCheckboxElements[0].disabled = false;

                    for (var i = 0; i &lt; dynamicElements.length; i++) {
                        for (var j = 0; j &lt; dynamicElements[i].length; j++) {
                            if (overrideGlobalThresholdConditionsCheckboxElements[0].checked) {
                                dynamicElements[i][j].parentNode.parentNode.style.display = "";
                            } else {
                                dynamicElements[i][j].parentNode.parentNode.style.display = "none";
                            }

                        }
                    }


                } else {
                    overrideGlobalThresholdConditionsCheckboxElements[0].disabled = true;
                    overrideGlobalThresholdConditionsCheckboxElements[0].checked = false;

                    for (var i = 0; i &lt; dynamicElements.length; i++) {
                        for (var j = 0; j &lt; dynamicElements[i].length; j++) {
                            dynamicElements[i][j].parentNode.parentNode.style.display = "none";
                        }
                    }
                }
            });
        }
    </script>

</j:jelly>
package com.aspectsecurity.contrast.contrastjenkins.plots;

import com.aspectsecurity.contrast.contrastjenkins.VulnerabilityFrequencyAction;
import hudson.model.AbstractProject;
import hudson.model.Run;
import hudson.util.Graph;
import hudson.util.RunList;
import hudson.util.ShiftedCategoryAxis;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.CategoryAxis;
import org.jfree.chart.axis.NumberAxis;
import org.jfree.chart.plot.CategoryPlot;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.renderer.category.BarRenderer;
import org.jfree.data.category.DefaultCategoryDataset;
import org.jfree.ui.RectangleInsets;

import java.awt.*;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.List;
import java.util.Map;


public class VulnerabilityFrequencyPlot extends Graph {

    private AbstractProject<?, ?> project;

    public VulnerabilityFrequencyPlot(AbstractProject<?, ?> project) {
        super(Calendar.getInstance(), 500, 200);
        this.project = project;
    }

    @Override
    protected JFreeChart createGraph() {
        DefaultCategoryDataset dataset = createVulnerabilityFrequencyDataset();

        JFreeChart chart = ChartFactory.createStackedBarChart(
                null, // title
                "Build Number", // x axis title
                "Vulnerability Count", // y axis title
                dataset, // data
                PlotOrientation.VERTICAL, // orientation
                true, // legend
                true, // tooltips
                false); // urls

        chart.setBackgroundPaint(Color.white);

        CategoryPlot plot = (CategoryPlot) chart.getPlot();
        plot.setBackgroundPaint(Color.WHITE);
        plot.setOutlinePaint(null);
        plot.setRangeGridlinesVisible(true);
        plot.setRangeGridlinePaint(Color.black);

        BarRenderer renderer = (BarRenderer) plot.getRenderer();
        setColors(renderer);

        // Set colors here
        plot.setRenderer(renderer);

        CategoryAxis domainAxis = new ShiftedCategoryAxis("Build Number");
        plot.setDomainAxis(domainAxis);

        NumberAxis rangeAxis = (NumberAxis) plot.getRangeAxis();
        rangeAxis.setStandardTickUnits(NumberAxis.createIntegerTickUnits());
        rangeAxis.setAutoRange(true);

        plot.setInsets(new RectangleInsets(0, 0, 0, 5.0));

        return chart;
    }

    private DefaultCategoryDataset createVulnerabilityFrequencyDataset() {
        List<VulnerabilityFrequencyAction> actions = new ArrayList<>();
        RunList<?> builds = project.getBuilds().limit(10);

        // Get all build actions
        for (Run<?, ?> run : builds) {
            VulnerabilityFrequencyAction action = run.getAction(VulnerabilityFrequencyAction.class);

            if (action == null) {
                continue;
            }
            actions.add(action);
        }

        // put them in chronological order
        Collections.reverse(actions);

        // build data setup
        DefaultCategoryDataset ds = new DefaultCategoryDataset();
        for (VulnerabilityFrequencyAction action : actions) {
            Map<String, Integer> result = action.getResult().getTraceResult();

            for (Map.Entry<String, Integer> entry : result.entrySet()) {
                ds.addValue(entry.getValue(), entry.getKey(), Integer.toString(action.getBuildNumber()));
            }
        }
        return ds;
    }

    private List<Color> setColors(BarRenderer renderer) {
        List<Color> colors = new ArrayList<>();

        renderer.setSeriesPaint(0, new Color(60, 195, 178));
        renderer.setSeriesPaint(1 ,new Color(174, 205, 67));
        renderer.setSeriesPaint(2, new Color(247, 182, 0));
        renderer.setSeriesPaint(3, new Color(94, 68, 130));
        renderer.setSeriesPaint(4, new Color(247, 138, 49));

        renderer.setSeriesPaint(5, new Color(60, 195, 178, 128));
        renderer.setSeriesPaint(6, new Color(174, 205, 67, 128));
        renderer.setSeriesPaint(7, new Color(247, 182, 0, 128));
        renderer.setSeriesPaint(8, new Color(94, 68, 130, 128));
        renderer.setSeriesPaint(9, new Color(247, 138, 49, 128));

        renderer.setSeriesPaint(10, new Color(49, 67, 78));
        renderer.setSeriesPaint(11, new Color(37, 140, 191));
        renderer.setSeriesPaint(12, new Color(230, 48, 37));

        renderer.setSeriesPaint(13, new Color(49, 67, 78, 128));
        renderer.setSeriesPaint(14, new Color(37, 140, 191, 128));
        renderer.setSeriesPaint(15, new Color(230, 48, 37, 128));

        return colors;
    }
}
